#!/usr/bin/env node

/**
 * Chronicle Reports Audit Script
 * 
 * This script audits the current state of Chronicle reports in both
 * ChronicleReport table and atriumDocument table to verify data integrity.
 */

const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function auditChronicleReports() {
  try {
    console.log('üîç Chronicle Reports Audit');
    console.log('========================\n');

    // Get Notary Everyday workspace ID
    const workspace = await prisma.workspaces.findFirst({
      where: {
        OR: [
          { id: '01K1VBYmf75hgmvmz06psnc9ug' },
          { id: '01K7DNYR5VZ7JY36KGKKN76XZ1' },
          { id: 'cmezxb1ez0001pc94yry3ntjk' }
        ]
      },
      select: {
        id: true,
        name: true,
        slug: true
      }
    });

    if (!workspace) {
      console.log('‚ùå Notary Everyday workspace not found');
      return;
    }

    console.log(`üìÅ Workspace: ${workspace.name} (${workspace.slug})`);
    console.log(`üÜî ID: ${workspace.id}\n`);

    // Check ChronicleReport table
    console.log('üìä ChronicleReport Table:');
    console.log('-------------------------');
    
    const chronicleReports = await prisma.chronicleReport.findMany({
      where: {
        workspaceId: workspace.id
      },
      include: {
        ChronicleShare: true
      },
      orderBy: {
        createdAt: 'desc'
      }
    });

    console.log(`Total reports: ${chronicleReports.length}`);
    
    if (chronicleReports.length > 0) {
      console.log('\nüìã Report Details:');
      chronicleReports.forEach((report, index) => {
        console.log(`  ${index + 1}. ${report.title}`);
        console.log(`     - Type: ${report.reportType}`);
        console.log(`     - Created: ${report.createdAt.toISOString()}`);
        console.log(`     - Week Start: ${report.weekStart.toISOString()}`);
        console.log(`     - Week End: ${report.weekEnd.toISOString()}`);
        console.log(`     - Shares: ${report.ChronicleShare.length}`);
        console.log('');
      });
    }

    // Check atriumDocument table for Chronicle reports
    console.log('üìÑ Atrium Documents (Chronicle):');
    console.log('--------------------------------');
    
    const atriumChronicleDocs = await prisma.workshopDocument.findMany({
      where: {
        workspaceId: workspace.id,
        sourceRecordType: 'CHRONICLE',
        deletedAt: null
      },
      include: {
        createdBy: {
          select: {
            name: true,
            email: true
          }
        },
        activities: {
          where: {
            activityType: 'CREATED'
          },
          take: 1,
          orderBy: {
            createdAt: 'desc'
          }
        }
      },
      orderBy: {
        createdAt: 'desc'
      }
    });

    console.log(`Total Chronicle documents in Atrium: ${atriumChronicleDocs.length}`);
    
    if (atriumChronicleDocs.length > 0) {
      console.log('\nüìã Atrium Document Details:');
      atriumChronicleDocs.forEach((doc, index) => {
        console.log(`  ${index + 1}. ${doc.title}`);
        console.log(`     - Type: ${doc.documentType}`);
        console.log(`     - Report Type: ${doc.reportType}`);
        console.log(`     - Created By: ${doc.createdBy.name} (${doc.createdBy.email})`);
        console.log(`     - Created: ${doc.createdAt.toISOString()}`);
        console.log(`     - Generated by AI: ${doc.generatedByAI}`);
        console.log(`     - Tags: ${doc.tags.join(', ') || 'None'}`);
        if (doc.activities.length > 0) {
          console.log(`     - Activity: ${doc.activities[0].description}`);
        }
        console.log('');
      });
    }

    // Check for this week's reports
    console.log('üìÖ This Week Analysis:');
    console.log('----------------------');
    
    const now = new Date();
    const startOfWeek = new Date(now);
    startOfWeek.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
    startOfWeek.setHours(0, 0, 0, 0);
    
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); // End of week (Saturday)
    endOfWeek.setHours(23, 59, 59, 999);

    console.log(`Week period: ${startOfWeek.toISOString()} to ${endOfWeek.toISOString()}`);

    // Check daily reports for this week
    const thisWeekChronicleReports = chronicleReports.filter(report => {
      const reportDate = new Date(report.createdAt);
      return reportDate >= startOfWeek && reportDate <= endOfWeek;
    });

    const thisWeekAtriumDocs = atriumChronicleDocs.filter(doc => {
      const docDate = new Date(doc.createdAt);
      return docDate >= startOfWeek && docDate <= endOfWeek;
    });

    console.log(`Chronicle reports this week: ${thisWeekChronicleReports.length}`);
    console.log(`Atrium documents this week: ${thisWeekAtriumDocs.length}`);

    // Check for each day of this week
    console.log('\nüìÜ Daily Report Check:');
    for (let i = 0; i < 7; i++) {
      const day = new Date(startOfWeek);
      day.setDate(startOfWeek.getDate() + i);
      const dayEnd = new Date(day);
      dayEnd.setHours(23, 59, 59, 999);
      
      const dayName = day.toLocaleDateString('en-US', { weekday: 'long' });
      const dayStr = day.toISOString().split('T')[0];
      
      const dayReports = thisWeekChronicleReports.filter(report => {
        const reportDate = new Date(report.createdAt);
        return reportDate >= day && reportDate <= dayEnd;
      });
      
      const dayAtriumDocs = thisWeekAtriumDocs.filter(doc => {
        const docDate = new Date(doc.createdAt);
        return docDate >= day && docDate <= dayEnd;
      });
      
      console.log(`  ${dayName} (${dayStr}): Chronicle=${dayReports.length}, Atrium=${dayAtriumDocs.length}`);
    }

    // Check for weekly reports
    console.log('\nüìä Weekly Report Check:');
    const weeklyChronicleReports = chronicleReports.filter(report => 
      report.reportType === 'WEEKLY' || report.reportType === 'FRIDAY_RECAP'
    );
    const weeklyAtriumDocs = atriumChronicleDocs.filter(doc => 
      doc.reportType === 'WEEKLY' || doc.reportType === 'FRIDAY_RECAP'
    );
    
    console.log(`Weekly Chronicle reports: ${weeklyChronicleReports.length}`);
    console.log(`Weekly Atrium documents: ${weeklyAtriumDocs.length}`);

    // Check for bi-weekly/presentation reports
    console.log('\nüéØ Bi-weekly/Presentation Report Check:');
    const presentationChronicleReports = chronicleReports.filter(report => 
      report.reportType === 'PITCH' || report.reportType === 'BIWEEKLY'
    );
    const presentationAtriumDocs = atriumChronicleDocs.filter(doc => 
      doc.reportType === 'PITCH' || doc.reportType === 'BIWEEKLY'
    );
    
    console.log(`Presentation Chronicle reports: ${presentationChronicleReports.length}`);
    console.log(`Presentation Atrium documents: ${presentationAtriumDocs.length}`);

    // Summary
    console.log('\nüìà Summary:');
    console.log('-----------');
    console.log(`‚úÖ ChronicleReport table: ${chronicleReports.length} reports`);
    console.log(`‚úÖ Atrium documents: ${atriumChronicleDocs.length} documents`);
    console.log(`üìÖ This week reports: ${thisWeekChronicleReports.length} Chronicle, ${thisWeekAtriumDocs.length} Atrium`);
    console.log(`üìä Weekly reports: ${weeklyChronicleReports.length} Chronicle, ${weeklyAtriumDocs.length} Atrium`);
    console.log(`üéØ Presentation reports: ${presentationChronicleReports.length} Chronicle, ${presentationAtriumDocs.length} Atrium`);

    if (thisWeekChronicleReports.length === 0 && thisWeekAtriumDocs.length === 0) {
      console.log('\n‚ö†Ô∏è  WARNING: No reports found for this week!');
    }

  } catch (error) {
    console.error('‚ùå Error during audit:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the audit
if (require.main === module) {
  auditChronicleReports();
}

module.exports = { auditChronicleReports };
