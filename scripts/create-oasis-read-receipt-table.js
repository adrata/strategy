/**
 * Script to create OasisReadReceipt table directly in the database
 * Run this if migrations are blocked or table is missing
 */

const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const path = require('path');

const prisma = new PrismaClient();

async function createOasisReadReceiptTable() {
  try {
    console.log('ðŸ“ Creating OasisReadReceipt table...');
    
    // Check if table already exists
    const tableExists = await prisma.$queryRawUnsafe(`
      SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name = 'OasisReadReceipt'
      );
    `);
    
    if (Array.isArray(tableExists) && tableExists[0]?.exists) {
      console.log('âœ… OasisReadReceipt table already exists');
      return;
    }
    
    // Create the table
    const createTableSQL = `
    //   CREATE TABLE IF NOT EXISTS "OasisReadReceipt" (
    //     "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    //     "userId" VARCHAR(30) NOT NULL,
    //     "messageId" TEXT NOT NULL,
    //     "readAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    //     
    //     CONSTRAINT "OasisReadReceipt_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE,
    //     CONSTRAINT "OasisReadReceipt_messageId_fkey" FOREIGN KEY ("messageId") REFERENCES "OasisMessage"("id") ON DELETE CASCADE,
    //     
    //     CONSTRAINT "OasisReadReceipt_userId_messageId_key" UNIQUE ("userId", "messageId")
    //   );
    //   
    //   CREATE INDEX IF NOT EXISTS "OasisReadReceipt_userId_idx" ON "OasisReadReceipt"("userId");
    //   CREATE INDEX IF NOT EXISTS "OasisReadReceipt_messageId_idx" ON "OasisReadReceipt"("messageId");
    //   CREATE INDEX IF NOT EXISTS "OasisReadReceipt_readAt_idx" ON "OasisReadReceipt"("readAt");
    // `;
    
    // Use Prisma's introspection to get the exact table structure
    // Based on schema, the table should be:
    // Note: id uses cuid() which is generated by Prisma, not by DB default
    const sql = `
      CREATE TABLE IF NOT EXISTS "OasisReadReceipt" (
        "id" TEXT PRIMARY KEY,
        "userId" VARCHAR(30) NOT NULL,
        "messageId" TEXT NOT NULL,
        "readAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        CONSTRAINT "OasisReadReceipt_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users"("id") ON DELETE CASCADE,
        CONSTRAINT "OasisReadReceipt_messageId_fkey" FOREIGN KEY ("messageId") REFERENCES "OasisMessage"("id") ON DELETE CASCADE,
        
        CONSTRAINT "OasisReadReceipt_userId_messageId_key" UNIQUE ("userId", "messageId")
      );
      
      CREATE INDEX IF NOT EXISTS "OasisReadReceipt_userId_idx" ON "OasisReadReceipt"("userId");
      CREATE INDEX IF NOT EXISTS "OasisReadReceipt_messageId_idx" ON "OasisReadReceipt"("messageId");
      CREATE INDEX IF NOT EXISTS "OasisReadReceipt_readAt_idx" ON "OasisReadReceipt"("readAt");
    `;
    
    await prisma.$executeRawUnsafe(sql);
    
    console.log('âœ… OasisReadReceipt table created successfully!');
    
    // Verify table was created
    const verify = await prisma.$queryRawUnsafe(`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = 'OasisReadReceipt'
    `);
    
    console.log('âœ… Verification:', verify);
    
  } catch (error) {
    if (error.message.includes('already exists') || error.message.includes('duplicate')) {
      console.log('âš ï¸  Table may already exist, continuing...');
    } else {
      console.error('âŒ Error creating OasisReadReceipt table:', error.message);
      throw error;
    }
  } finally {
    await prisma.$disconnect();
  }
}

createOasisReadReceiptTable()
  .then(() => {
    console.log('ðŸŽ‰ Done!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('ðŸ’¥ Failed:', error);
    process.exit(1);
  });

