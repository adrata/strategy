/**
 * Comprehensive Executive Enrichment Test
 * Integrates CoreSignal + Adaptive Waterfall Enrichment for >80% accuracy
 * Tests with real Key Account Domains CSV data
 */

const fetch = globalThis.fetch || require('node-fetch');
const fs = require('fs');
const path = require('path');

// Test Configuration
const BASE_URL = 'http://localhost:3000';
const CORESIGNAL_API_KEY = process.env.CORESIGNAL_API_KEY || 'CREDENTIAL_REMOVED_FOR_SECURITY';

// Load CSV data
function loadCSVData() {
  try {
    const csvPath = path.join(__dirname, '..', 'Key Account Domains.csv');
    const csvContent = fs.readFileSync(csvPath, 'utf-8');
    const lines = csvContent.split('\\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.trim().replace(/\"/g, ''));\n    \n    const companies = [];\n    for (let i = 1; i < Math.min(11, lines.length); i++) { // Test first 10 companies\n      const values = lines[i].split(',').map(v => v.trim().replace(/\"/g, ''));\n      if (values.length >= headers.length && values[0]) {\n        const domain = values[0].toLowerCase().replace(/^https?:\\/\\//, '').replace(/^www\\./, '');\n        const companyName = domain.split('.')[0]\n          .replace(/-/g, ' ')\n          .replace(/\\b\\w/g, l => l.toUpperCase());\n        \n        companies.push({\n          domain: domain,\n          name: companyName,\n          industry: 'Technology'\n        });\n      }\n    }\n    \n    console.log(`üìä Loaded ${companies.length} companies from CSV`);\n    return companies;\n  } catch (error) {\n    console.error('‚ùå Error loading CSV:', error.message);\n    return [];\n  }\n}\n\n// Test our Role Finder API (integrates CoreSignal + Waterfall)\nasync function testRoleFinderAPI(company, role) {\n  try {\n    console.log(`üîç Testing Role Finder API for ${role} at ${company.name}...`);\n    \n    const response = await fetch(`${BASE_URL}/api/role-finder`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        inputType: 'single',\n        company: company.domain,\n        roles: [role],\n        workspaceId: 'adrata',\n        userId: 'test-user',\n        config: {\n          includeContactInfo: true,\n          maxResultsPerCompany: 1,\n          minConfidenceScore: 60\n        }\n      })\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.log(`‚ö†Ô∏è  Role Finder API failed: ${response.status}`);\n      console.log('Error details:', errorText);\n      return { success: false, error: `API failed: ${response.status}` };\n    }\n    \n    const result = await response.json();\n    \n    if (result.success && result.data?.report?.results?.length > 0) {\n      const executive = result.data.report.results[0];\n      return {\n        success: true,\n        data: {\n          name: executive.person?.fullName || executive.person?.name || 'Unknown',\n          title: executive.role?.name || executive.person?.title || 'Unknown',\n          email: executive.person?.email || executive.contactInfo?.email || null,\n          company: company.name,\n          domain: company.domain,\n          confidence: executive.confidence || 0,\n          source: 'RoleFinderAPI',\n          lastUpdated: executive.person?.lastUpdated || new Date().toISOString()\n        }\n      };\n    } else {\n      return { success: false, error: 'No results found' };\n    }\n    \n  } catch (error) {\n    console.error(`‚ùå Role Finder API error:`, error.message);\n    return { success: false, error: error.message };\n  }\n}\n\n// Test Waterfall Enrichment API\nasync function testWaterfallEnrichmentAPI(company, role) {\n  try {\n    console.log(`üåä Testing Waterfall Enrichment for ${role} at ${company.name}...`);\n    \n    const response = await fetch(`${BASE_URL}/api/enrichment/waterfall`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        type: 'person_search',\n        query: {\n          company: company.domain,\n          role: role,\n          includeContactInfo: true\n        },\n        config: {\n          maxProviders: 3,\n          minConfidence: 70,\n          includeFallback: true\n        }\n      })\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.log(`‚ö†Ô∏è  Waterfall Enrichment failed: ${response.status}`);\n      return { success: false, error: `Waterfall failed: ${response.status}` };\n    }\n    \n    const result = await response.json();\n    \n    if (result.success && result.data) {\n      return {\n        success: true,\n        data: {\n          name: result.data.name || 'Unknown',\n          title: result.data.title || 'Unknown',\n          email: result.data.email || null,\n          company: company.name,\n          domain: company.domain,\n          confidence: result.confidence || 0,\n          source: 'WaterfallEnrichment',\n          providers: result.providersUsed || [],\n          lastUpdated: result.data.lastUpdated || new Date().toISOString()\n        }\n      };\n    } else {\n      return { success: false, error: 'No enrichment data found' };\n    }\n    \n  } catch (error) {\n    console.error(`‚ùå Waterfall Enrichment error:`, error.message);\n    return { success: false, error: error.message };\n  }\n}\n\n// Fallback: Direct CoreSignal search\nasync function fallbackCoreSignalSearch(company, role) {\n  try {\n    console.log(`üîÑ Fallback: Direct CoreSignal search for ${role} at ${company.name}...`);\n    \n    // Use the working CoreSignal logic from our previous test\n    const companyResponse = await fetch(\n      `https://api.coresignal.com/cdapi/v2/company_multi_source/enrich?website=${company.domain}`,\n      {\n        method: 'GET',\n        headers: {\n          'apikey': CORESIGNAL_API_KEY,\n          'Accept': 'application/json'\n        }\n      }\n    );\n    \n    if (!companyResponse.ok) {\n      return { success: false, error: `Company not found: ${companyResponse.status}` };\n    }\n    \n    const companyData = await companyResponse.json();\n    \n    // Search for employees\n    const employeeSearchQuery = {\n      \"query\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"nested\": {\n                \"path\": \"experience\",\n                \"query\": {\n                  \"bool\": {\n                    \"must\": [\n                      {\n                        \"term\": {\n                          \"experience.company_id\": companyData.id\n                        }\n                      },\n                      {\n                        \"query_string\": {\n                          \"query\": role,\n                          \"default_field\": \"experience.position_title\",\n                          \"default_operator\": \"and\"\n                        }\n                      }\n                    ]\n                  }\n                }\n              }\n            }\n          ]\n        }\n      },\n      \"sort\": [\"_score\"]\n    };\n    \n    const employeeResponse = await fetch(\n      `https://api.coresignal.com/cdapi/v2/employee_multi_source/search/es_dsl?items_per_page=1`,\n      {\n        method: 'POST',\n        headers: {\n          'apikey': CORESIGNAL_API_KEY,\n          'Content-Type': 'application/json',\n          'Accept': 'application/json'\n        },\n        body: JSON.stringify(employeeSearchQuery)\n      }\n    );\n    \n    if (!employeeResponse.ok || !(await employeeResponse.json()).length) {\n      return { success: false, error: 'No employees found' };\n    }\n    \n    const employeeIds = await employeeResponse.json();\n    \n    if (employeeIds.length === 0) {\n      return { success: false, error: 'No matching employees' };\n    }\n    \n    // Get employee details\n    const employeeDetailResponse = await fetch(\n      `https://api.coresignal.com/cdapi/v2/employee_multi_source/collect/${employeeIds[0]}`,\n      {\n        method: 'GET',\n        headers: {\n          'apikey': CORESIGNAL_API_KEY,\n          'Accept': 'application/json'\n        }\n      }\n    );\n    \n    if (!employeeDetailResponse.ok) {\n      return { success: false, error: 'Employee details not found' };\n    }\n    \n    const employeeDetail = await employeeDetailResponse.json();\n    \n    return {\n      success: true,\n      data: {\n        name: employeeDetail.full_name || 'Unknown',\n        title: employeeDetail.active_experience_title || 'Unknown',\n        email: employeeDetail.primary_professional_email || null,\n        company: company.name,\n        domain: company.domain,\n        confidence: 85, // Default confidence for CoreSignal\n        source: 'CoreSignalDirect',\n        lastUpdated: employeeDetail.updated_at || new Date().toISOString()\n      }\n    };\n    \n  } catch (error) {\n    console.error(`‚ùå CoreSignal fallback error:`, error.message);\n    return { success: false, error: error.message };\n  }\n}\n\n// Comprehensive search with multiple strategies\nasync function comprehensiveExecutiveSearch(company, role) {\n  console.log(`\\nüéØ Comprehensive search for ${role} at ${company.name}`);\n  console.log('-'.repeat(50));\n  \n  // Strategy 1: Role Finder API (our integrated system)\n  let result = await testRoleFinderAPI(company, role);\n  if (result.success) {\n    console.log(`‚úÖ Found via Role Finder API: ${result.data.name} - ${result.data.title}`);\n    return result;\n  }\n  \n  // Strategy 2: Waterfall Enrichment API\n  result = await testWaterfallEnrichmentAPI(company, role);\n  if (result.success) {\n    console.log(`‚úÖ Found via Waterfall Enrichment: ${result.data.name} - ${result.data.title}`);\n    return result;\n  }\n  \n  // Strategy 3: Direct CoreSignal fallback\n  result = await fallbackCoreSignalSearch(company, role);\n  if (result.success) {\n    console.log(`‚úÖ Found via CoreSignal Direct: ${result.data.name} - ${result.data.title}`);\n    return result;\n  }\n  \n  console.log(`‚ùå All strategies failed for ${role} at ${company.name}`);\n  return { success: false, error: 'All search strategies failed' };\n}\n\n// Calculate comprehensive confidence score\nfunction calculateComprehensiveConfidence(executiveData) {\n  let score = 0;\n  let reasons = [];\n  \n  // Name validation (20 points)\n  if (executiveData.name && executiveData.name !== 'Unknown' && executiveData.name.trim().length > 2) {\n    score += 20;\n    reasons.push(\"‚úÖ Valid name\");\n  } else {\n    reasons.push(\"‚ùå No valid name\");\n  }\n  \n  // Title validation (30 points)\n  if (executiveData.title && executiveData.title !== 'Unknown') {\n    const title = executiveData.title.toLowerCase();\n    const targetRole = executiveData.targetRole || '';\n    \n    if ((targetRole === 'cfo' && (title.includes('cfo') || title.includes('chief financial'))) ||\n        (targetRole === 'ceo' && (title.includes('ceo') || title.includes('chief executive')))) {\n      score += 30;\n      reasons.push(\"‚úÖ Perfect title match\");\n    } else if (title.includes('chief') || title.includes('president') || title.includes('founder')) {\n      score += 20;\n      reasons.push(\"‚ö†Ô∏è  Executive-level title\");\n    } else {\n      score += 5;\n      reasons.push(\"‚ùå Title mismatch\");\n    }\n  } else {\n    reasons.push(\"‚ùå No title\");\n  }\n  \n  // Email validation (25 points)\n  if (executiveData.email && executiveData.email.includes('@') && executiveData.email.includes('.')) {\n    score += 25;\n    reasons.push(\"‚úÖ Valid email\");\n  } else {\n    reasons.push(\"‚ùå No email\");\n  }\n  \n  // Source reliability (15 points)\n  if (executiveData.source === 'RoleFinderAPI') {\n    score += 15;\n    reasons.push(\"‚úÖ Integrated API source\");\n  } else if (executiveData.source === 'CoreSignalDirect') {\n    score += 12;\n    reasons.push(\"‚úÖ CoreSignal direct\");\n  } else if (executiveData.source === 'WaterfallEnrichment') {\n    score += 10;\n    reasons.push(\"‚ö†Ô∏è  Waterfall enrichment\");\n  } else {\n    reasons.push(\"‚ùå Unknown source\");\n  }\n  \n  // Data freshness (10 points)\n  if (executiveData.lastUpdated) {\n    const updateDate = new Date(executiveData.lastUpdated);\n    const monthsOld = (Date.now() - updateDate.getTime()) / (1000 * 60 * 60 * 24 * 30);\n    \n    if (monthsOld < 6) {\n      score += 10;\n      reasons.push(\"‚úÖ Recent data\");\n    } else if (monthsOld < 12) {\n      score += 5;\n      reasons.push(\"‚ö†Ô∏è  Older data\");\n    } else {\n      reasons.push(\"‚ùå Very old data\");\n    }\n  } else {\n    reasons.push(\"‚ùå No timestamp\");\n  }\n  \n  return {\n    score: Math.min(score, 100),\n    level: getConfidenceLevel(score),\n    reasons: reasons\n  };\n}\n\nfunction getConfidenceLevel(score) {\n  if (score >= 95) return 'EXCELLENT';\n  if (score >= 85) return 'VERY GOOD';\n  if (score >= 75) return 'GOOD';\n  if (score >= 65) return 'FAIR';\n  if (score >= 50) return 'POOR';\n  return 'UNACCEPTABLE';\n}\n\n// Main test function\nasync function runComprehensiveExecutiveTest() {\n  console.log('üöÄ COMPREHENSIVE EXECUTIVE ENRICHMENT TEST');\n  console.log('üéØ Target: >80% accuracy with multiple fallback strategies\\n');\n  \n  const companies = loadCSVData();\n  if (companies.length === 0) {\n    console.error('‚ùå No companies loaded. Exiting.');\n    return;\n  }\n  \n  const results = [];\n  let totalTests = 0;\n  let successfulFinds = 0;\n  let highConfidenceFinds = 0;\n  \n  for (const company of companies) {\n    console.log(`\\nüè¢ Testing: ${company.name} (${company.domain})`);\n    console.log('='.repeat(60));\n    \n    // Test CFO search\n    totalTests++;\n    const cfoResult = await comprehensiveExecutiveSearch(company, 'CFO');\n    \n    let cfoData = null;\n    let cfoConfidence = null;\n    \n    if (cfoResult.success) {\n      cfoData = cfoResult.data;\n      cfoData.targetRole = 'cfo';\n      cfoConfidence = calculateComprehensiveConfidence(cfoData);\n      successfulFinds++;\n      \n      if (cfoConfidence.score >= 75) {\n        highConfidenceFinds++;\n      }\n      \n      console.log(`üìä CFO Confidence: ${cfoConfidence.score}% (${cfoConfidence.level})`);\n      console.log(`   Reasoning: ${cfoConfidence.reasons.join(', ')}`);\n    }\n    \n    // Test CEO search\n    totalTests++;\n    const ceoResult = await comprehensiveExecutiveSearch(company, 'CEO');\n    \n    let ceoData = null;\n    let ceoConfidence = null;\n    \n    if (ceoResult.success) {\n      ceoData = ceoResult.data;\n      ceoData.targetRole = 'ceo';\n      ceoConfidence = calculateComprehensiveConfidence(ceoData);\n      successfulFinds++;\n      \n      if (ceoConfidence.score >= 75) {\n        highConfidenceFinds++;\n      }\n      \n      console.log(`üìä CEO Confidence: ${ceoConfidence.score}% (${ceoConfidence.level})`);\n      console.log(`   Reasoning: ${ceoConfidence.reasons.join(', ')}`);\n    }\n    \n    // Store results\n    results.push({\n      company: company.name,\n      domain: company.domain,\n      cfo: cfoData,\n      cfoConfidence: cfoConfidence,\n      ceo: ceoData,\n      ceoConfidence: ceoConfidence\n    });\n    \n    // Rate limiting\n    await new Promise(resolve => setTimeout(resolve, 2000));\n  }\n  \n  // Calculate final metrics\n  const overallAccuracy = (successfulFinds / totalTests) * 100;\n  const highConfidenceAccuracy = (highConfidenceFinds / totalTests) * 100;\n  \n  console.log('\\n' + '='.repeat(80));\n  console.log('üìä COMPREHENSIVE TEST RESULTS');\n  console.log('='.repeat(80));\n  console.log(`üéØ Target: >80% accuracy to win the account`);\n  console.log(`üìà Overall Accuracy: ${overallAccuracy.toFixed(1)}% (${successfulFinds}/${totalTests})`);\n  console.log(`‚≠ê High Confidence (75%+): ${highConfidenceAccuracy.toFixed(1)}% (${highConfidenceFinds}/${totalTests})`);\n  \n  if (overallAccuracy >= 80) {\n    console.log('üéâ SUCCESS: System exceeds 80% accuracy benchmark!');\n    console.log('‚úÖ READY FOR MONDAY LAUNCH!');\n  } else {\n    console.log('‚ö†Ô∏è  WARNING: Below 80% accuracy benchmark');\n    console.log('üîß System needs optimization before launch');\n  }\n  \n  // Export results to CSV\n  const csvResults = [];\n  csvResults.push(['Company', 'Domain', 'CFO Name', 'CFO Title', 'CFO Email', 'CFO Confidence', 'CEO Name', 'CEO Title', 'CEO Email', 'CEO Confidence']);\n  \n  results.forEach(result => {\n    csvResults.push([\n      result.company,\n      result.domain,\n      result.cfo?.name || 'Not Found',\n      result.cfo?.title || 'Not Found',\n      result.cfo?.email || 'Not Found',\n      result.cfoConfidence?.score || 0,\n      result.ceo?.name || 'Not Found',\n      result.ceo?.title || 'Not Found',\n      result.ceo?.email || 'Not Found',\n      result.ceoConfidence?.score || 0\n    ]);\n  });\n  \n  const csvContent = csvResults.map(row => row.join(',')).join('\\n');\n  fs.writeFileSync('test-outputs/executive-enrichment-results.csv', csvContent);\n  console.log('\\nüìÑ Results exported to: test-outputs/executive-enrichment-results.csv');\n  \n  return {\n    overallAccuracy,\n    highConfidenceAccuracy,\n    results,\n    passedBenchmark: overallAccuracy >= 80\n  };\n}\n\n// Run the test\nif (require.main === module) {\n  runComprehensiveExecutiveTest()\n    .then(results => {\n      if (results && results.passedBenchmark) {\n        console.log('\\nüöÄ SYSTEM VALIDATION: PASSED');\n        process.exit(0);\n      } else {\n        console.log('\\n‚ùå SYSTEM VALIDATION: FAILED');\n        process.exit(1);\n      }\n    })\n    .catch(error => {\n      console.error('üí• Test failed:', error);\n      process.exit(1);\n    });\n}\n\nmodule.exports = { runComprehensiveExecutiveTest };
