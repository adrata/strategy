generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// RBAC models for granular permission control
model roles {
  id               String             @id @default(ulid())
  name             String             @unique @db.VarChar(50)
  description      String?            @db.VarChar(255)
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  role_permissions role_permissions[]
  user_roles       user_roles[]

  @@index([isActive])
}

model permissions {
  id               String             @id @default(ulid())
  name             Permission         @unique
  description      String?            @db.VarChar(255)
  resource         String             @db.VarChar(50)
  action           String             @db.VarChar(50)
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  role_permissions role_permissions[]

  @@index([resource, action])
  @@index([isActive])
}

model role_permissions {
  id           String      @id @default(ulid())
  roleId       String
  permissionId String
  createdAt    DateTime    @default(now())
  permission   permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model user_roles {
  id          String      @id @default(ulid())
  userId      String      @db.VarChar(30)
  roleId      String
  workspaceId String?     @db.VarChar(30)
  isActive    Boolean     @default(true)
  assignedAt  DateTime    @default(now())
  assignedBy  String?     @db.VarChar(30)
  expiresAt   DateTime?
  role        roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user        users       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   workspaces? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, workspaceId])
  @@index([userId])
  @@index([roleId])
  @@index([workspaceId])
  @@index([isActive])
  @@index([expiresAt])
}

/// Multi-tenant workspace management
model workspaces {
  id                        String                      @id @default(ulid())
  name                      String
  slug                      String                      @unique
  timezone                  String                      @default("UTC") @db.VarChar(50)
  description               String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  isActive                  Boolean                     @default(true)
  deletedAt                 DateTime?
  
  // üè¢ BUSINESS CONTEXT FIELDS (for AI context engineering)
  businessModel             String?                     @db.VarChar(100)  // e.g., "Engineering Consulting", "IT Staffing", "Notary Services"
  industry                  String?                     @db.VarChar(100)  // Primary industry focus
  serviceOfferings          String[]                    @default([])      // Core services provided
  productPortfolio          String[]                    @default([])      // Products/services sold
  valuePropositions         String[]                    @default([])      // Key value propositions
  targetIndustries          String[]                    @default([])      // ICP industries
  targetCompanySize         String[]                    @default([])      // ICP company sizes
  idealCustomerProfile      String?                     @db.VarChar(2000) // Detailed ICP description
  competitiveAdvantages     String[]                    @default([])      // What makes them unique
  salesMethodology          String?                     @db.VarChar(200)  // How they sell
  speedrunDailyTarget       Int?                        @default(50)
  speedrunWeeklyTarget      Int?                        @default(250)
  oasis_channels            OasisChannel[]
  oasis_direct_messages     OasisDirectMessage[]
  stacks_projects           StacksProject[]
  actions                   actions[]
  audit_logs                audit_logs[]
  auth_sessions             auth_sessions[]
  companies                 companies[]
  grand_central_connections grand_central_connections[]
  grand_central_workflows   grand_central_workflows[]
  people                    people[]
  user_roles                user_roles[]
  users                     users[]
  workspace_users           workspace_users[]
  ai_conversations          ai_conversations[]
  emails                    email_messages[]

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
}

/// User accounts and authentication
model users {
  id                        String                      @id @default(ulid())
  email                     String                      @unique
  password                  String?
  name                      String
  firstName                 String?
  lastName                  String?
  timezone                  String?                     @db.VarChar(50)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  lastLoginAt               DateTime?
  isActive                  Boolean                     @default(true)
  activeWorkspaceId         String?                     @db.VarChar(30)
  username                  String?                     @unique @db.VarChar(50)
  oasis_channel_members     OasisChannelMember[]
  oasis_dm_participants     OasisDMParticipant[]
  oasis_messages            OasisMessage[]
  oasis_reactions           OasisReaction[]
  stacks_story_assignees    StacksStory[]
  stacks_task_assignees     StacksTask[]
  assigned_actions          actions[]                   @relation("AssignedActions")
  audit_logs                audit_logs[]
  auth_sessions             auth_sessions[]
  main_seller_companies     companies[]                 @relation("MainSellerCompanies")
  grand_central_connections grand_central_connections[]
  grand_central_workflows   grand_central_workflows[]
  main_seller_people        people[]                    @relation("MainSellerPeople")
  person_co_sellers         person_co_sellers[]
  reset_tokens              reset_tokens[]
  user_roles                user_roles[]
  workspaces                workspaces?                 @relation(fields: [activeWorkspaceId], references: [id])
  workspace_users           workspace_users[]
  ai_conversations          ai_conversations[]

  @@index([activeWorkspaceId])
  @@index([username])
}

/// Workspace membership and basic roles
model workspace_users {
  id          String     @id @default(ulid())
  workspaceId String     @db.VarChar(30)
  userId      String     @db.VarChar(30)
  role        UserRole   @default(VIEWER)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  isActive    Boolean    @default(true)
  joinedAt    DateTime   @default(now())
  user        users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, role])
  @@index([isActive])
}

/// JWT session management
model auth_sessions {
  id             String     @id @default(ulid())
  userId         String     @db.VarChar(30)
  workspaceId    String     @db.VarChar(30)
  token          String     @unique @db.VarChar(500)
  refreshToken   String     @unique @db.VarChar(500)
  expiresAt      DateTime
  createdAt      DateTime   @default(now())
  lastAccessedAt DateTime   @default(now())
  isActive       Boolean    @default(true)
  user           users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace      workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([isActive])
  @@index([refreshToken])
  @@index([token])
  @@index([userId])
  @@index([workspaceId])
}

/// Password reset functionality
model reset_tokens {
  id        String   @id @default(ulid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([used])
  @@index([userId])
}

/// Company/organization data
model companies {
  id                     String           @id @default(ulid()) @db.VarChar(30)
  workspaceId            String           @db.VarChar(30)
  name                   String           @db.VarChar(255)
  legalName              String?          @db.VarChar(255)
  tradingName            String?          @db.VarChar(255)
  localName              String?          @db.VarChar(255)
  description            String?
  website                String?          @db.VarChar(500)
  email                  String?          @db.VarChar(300)
  phone                  String?          @db.VarChar(50)
  fax                    String?          @db.VarChar(50)
  address                String?
  city                   String?          @db.VarChar(100)
  state                  String?          @db.VarChar(100)
  country                String?          @db.VarChar(100)
  postalCode             String?          @db.VarChar(20)
  industry               String?          @db.VarChar(100)
  sector                 String?          @db.VarChar(100)
  size                   String?          @db.VarChar(100)
  revenue                Decimal?         @db.Decimal(15, 2)
  currency               String?          @default("USD") @db.VarChar(3)
  employeeCount          Int?
  foundedYear            Int?
  registrationNumber     String?          @db.VarChar(100)
  taxId                  String?          @db.VarChar(100)
  vatNumber              String?          @db.VarChar(100)
  domain                 String?          @db.VarChar(255)
  logoUrl                String?          @db.VarChar(500)
  status                 CompanyStatus?   @default(ACTIVE)
  priority               CompanyPriority? @default(MEDIUM)
  tags                   String[]         @default([])
  customFields           Json?
  notes                  String?
  lastAction             String?
  lastActionDate         DateTime?        @db.Timestamp(6)
  nextAction             String?
  nextActionDate         DateTime?        @db.Timestamp(6)
  nextActionReasoning    String?          @db.Text
  nextActionPriority     String?          @db.VarChar(20)
  nextActionType         String?          @db.VarChar(50)
  nextActionUpdatedAt    DateTime?
  actionStatus           String?
  globalRank             Int?             @default(0)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime
  entityId               String?          @db.VarChar(30)
  deletedAt              DateTime?
  mainSellerId           String?          @db.VarChar(30)
  actualCloseDate        DateTime?
  expectedCloseDate      DateTime?
  opportunityAmount      Decimal?         @db.Decimal(15, 2)
  opportunityProbability Float?
  opportunityStage       String?          @db.VarChar(50)
  
  // üß† COMPANY INTELLIGENCE DATA (CRITICAL SBI FIELDS)
  companyIntelligence    Json?            // Company analysis data
  businessChallenges     String[]         @default([])
  businessPriorities     String[]         @default([])
  competitiveAdvantages  String[]         @default([])
  growthOpportunities    String[]         @default([])
  strategicInitiatives   String[]         @default([])
  successMetrics         String[]         @default([])
  marketThreats          String[]         @default([])
  keyInfluencers         String?          @db.VarChar(200)
  decisionTimeline       String?          @db.VarChar(100)
  marketPosition         String?          @db.VarChar(100)
  digitalMaturity        Int?             @default(0)
  techStack              String[]         @default([])
  competitors            String[]         @default([])
  
  // üí∞ FINANCIAL & BUSINESS DATA
  lastFundingAmount      BigInt?
  lastFundingDate        DateTime?
  stockSymbol            String?          @db.VarChar(20)
  isPublic               Boolean?         @default(false)
  naicsCodes             String[]         @default([])
  sicCodes               String[]         @default([])
  
  // üåê SOCIAL MEDIA & ONLINE PRESENCE
  linkedinUrl            String?          @db.VarChar(500)
  linkedinFollowers      Int?
  twitterUrl             String?          @db.VarChar(500)
  twitterFollowers       Int?
  facebookUrl            String?          @db.VarChar(500)
  instagramUrl           String?          @db.VarChar(500)
  youtubeUrl             String?          @db.VarChar(500)
  githubUrl              String?          @db.VarChar(500)
  
  // üìç LOCATION & ADDRESS DATA
  hqLocation             String?          @db.VarChar(200)
  hqFullAddress          String?          @db.VarChar(500)
  hqCity                 String?          @db.VarChar(100)
  hqState                String?          @db.VarChar(100)
  hqStreet               String?          @db.VarChar(200)
  hqZipcode              String?          @db.VarChar(20)
  hqRegion               String[]         @default([])
  hqCountryIso2          String?          @db.VarChar(2)
  hqCountryIso3          String?          @db.VarChar(3)
  
  // üìä COMPANY UPDATES & ACTIVITY
  companyUpdates         Json?            // Company activity data
  activeJobPostings      Int?             @default(0)
  numTechnologiesUsed    Int?             @default(0)
  technologiesUsed       String[]         @default([])
  
  // üîç SBI SPECIFIC FIELDS (CRITICAL)
  confidence             Float?           @default(0)
  sources                String[]         @default([])
  acquisitionDate        DateTime?
  lastVerified           DateTime?
  parentCompanyName      String?          @db.VarChar(200)
  parentCompanyDomain    String?          @db.VarChar(200)
  
  actions                actions[]
  mainSeller             users?           @relation("MainSellerCompanies", fields: [mainSellerId], references: [id])
  workspace              workspaces       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  people                 people[]
  emails                 email_messages[]

  @@index([workspaceId])
  @@index([mainSellerId])
  @@index([entityId])
  @@index([deletedAt])
  @@index([workspaceId, status])
  @@index([workspaceId, mainSellerId, status])
  @@index([workspaceId, createdAt])
  @@index([customFields], type: Gin)
  @@index([workspaceId, globalRank])
  @@index([workspaceId, status, globalRank])
  @@index([confidence])
  @@index([lastVerified])
  @@index([acquisitionDate])
  @@index([marketPosition])
  @@index([digitalMaturity])
}

/// Contact/person records
model people {
  id                String              @id @default(ulid()) @db.VarChar(30)
  workspaceId       String              @db.VarChar(30)
  companyId         String?             @db.VarChar(30)
  firstName         String              @db.VarChar(100)
  lastName          String              @db.VarChar(100)
  fullName          String              @db.VarChar(200)
  displayName       String?             @db.VarChar(200)
  salutation        String?             @db.VarChar(50)
  suffix            String?             @db.VarChar(50)
  jobTitle          String?             @db.VarChar(300)
  title             String?             @db.VarChar(300)
  department        String?             @db.VarChar(200)
  seniority         String?             @db.VarChar(50)
  email             String?             @db.VarChar(300)
  workEmail         String?             @db.VarChar(300)
  personalEmail     String?             @db.VarChar(300)
  phone             String?             @db.VarChar(50)
  mobilePhone       String?             @db.VarChar(50)
  workPhone         String?             @db.VarChar(50)
  linkedinUrl       String?             @db.VarChar(500)
  linkedinNavigatorUrl String?          @db.VarChar(500)
  linkedinConnectionDate DateTime?      @db.Timestamp(6)
  address           String?             @db.VarChar(500)
  city              String?             @db.VarChar(100)
  state             String?             @db.VarChar(100)
  country           String?             @db.VarChar(100)
  postalCode        String?             @db.VarChar(50)
  dateOfBirth       DateTime?           @db.Timestamp(6)
  gender            String?             @db.VarChar(20)
  bio               String?
  profilePictureUrl String?             @db.VarChar(500)
  status            PersonStatus?       @default(LEAD)
  priority          PersonPriority?     @default(MEDIUM)
  source            String?
  tags              String[]            @default([])
  customFields      Json?
  notes             String?
  preferredLanguage String?             @db.VarChar(10)
  timezone          String?             @db.VarChar(50)
  emailVerified     Boolean?            @default(false)
  phoneVerified     Boolean?            @default(false)
  lastAction        String?
  lastActionDate    DateTime?           @db.Timestamp(6)
  nextAction        String?
  nextActionDate    DateTime?           @db.Timestamp(6)
  nextActionReasoning  String?          @db.Text
  nextActionPriority   String?          @db.VarChar(20)
  nextActionType       String?          @db.VarChar(50)
  nextActionUpdatedAt  DateTime?
  actionStatus      String?
  engagementScore   Float?              @default(0)
  globalRank        Int?                @default(0)
  companyRank       Int?                @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  entityId          String?             @db.VarChar(30)
  deletedAt         DateTime?
  mainSellerId      String?             @db.VarChar(30)
  vertical          String?             @db.VarChar(100)
  
  // üéØ CAREER DATA (CRITICAL SBI FIELDS)
  currentRole                String?             @db.VarChar(200)
  currentCompany             String?             @db.VarChar(200)
  yearsInRole                Int?
  yearsAtCompany             Int?
  totalExperience            Int?                // years
  industryExperience         String?             @db.VarChar(100)
  leadershipExperience       String?             @db.VarChar(100)
  budgetResponsibility       String?             @db.VarChar(100)
  teamSize                   String?             @db.VarChar(50)
  achievements               String[]            @default([])
  certifications             String[]            @default([])
  publications               String[]            @default([])
  speakingEngagements        String[]            @default([])
  
  // üéì EDUCATION DATA (CRITICAL SBI FIELDS)
  degrees                    Json?               // Array of education records
  institutions               String[]            @default([])
  fieldsOfStudy              String[]            @default([])
  graduationYears            Int[]               @default([])
  
  // üõ†Ô∏è SKILLS & EXPERTISE (CRITICAL SBI FIELDS)
  technicalSkills            String[]            @default([])
  softSkills                 String[]            @default([])
  industrySkills             String[]            @default([])
  languages                  String[]            @default([])
  
  // üìà EXPERIENCE & CAREER TIMELINE (CRITICAL SBI FIELDS)
  previousRoles              Json?               // Array of role records
  careerTimeline             Json?               // Chronological career data
  roleHistory                Json?               // Detailed role information
  
  // üëë BUYER GROUP & DECISION MAKING (CRITICAL SBI FIELDS)
  buyerGroupRole             String?             @db.VarChar(50)
  decisionPower              Int?                @default(0)
  influenceLevel             String?             @db.VarChar(50)
  influenceScore             Float?              @default(0)
  engagementLevel            String?             @db.VarChar(50)
  buyerGroupStatus           String?             @db.VarChar(50)
  isBuyerGroupMember         Boolean?            @default(false)
  buyerGroupOptimized        Boolean?            @default(false)
  decisionMaking             String?             @db.VarChar(50)
  communicationStyle         String?             @db.VarChar(50)
  engagementStrategy         String?             @db.VarChar(100)
  
  // üîç ENRICHMENT & INTELLIGENCE DATA (CRITICAL SBI FIELDS)
  enrichmentScore            Float?              @default(0)
  enrichmentSources          String[]            @default([])
  lastEnriched               DateTime?
  enrichmentVersion          String?             @db.VarChar(20)
  coresignalData             Json?               // Coresignal enrichment data
  enrichedData               Json?               // General enrichment data
  
  // üìû CONTACT & VERIFICATION DATA
  emailConfidence            Float?              @default(0)
  phoneConfidence            Float?              @default(0)
  mobileVerified             Boolean?            @default(false)
  dataCompleteness           Float?              @default(0)
  preferredContact           String?             @db.VarChar(50)
  responseTime               String?             @db.VarChar(50)
  
  // üìä STATUS & TRACKING
  statusReason               String?             @db.VarChar(200)
  statusUpdateDate           DateTime?
  hiddenFromSections         String[]            @default([])
  rolePromoted               Json?               // Role promotion data
  
  actions           actions[]
  company           companies?          @relation(fields: [companyId], references: [id])
  mainSeller        users?              @relation("MainSellerPeople", fields: [mainSellerId], references: [id])
  workspace         workspaces          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  coSellers         person_co_sellers[]
  emails            email_messages[]

  @@index([workspaceId])
  @@index([companyId])
  @@index([entityId])
  @@index([deletedAt])
  @@index([workspaceId, status])
  @@index([workspaceId, companyId, status])
  @@index([workspaceId, createdAt])
  @@index([customFields], type: Gin)
  @@index([mainSellerId])
  @@index([workspaceId, mainSellerId, status])
  @@index([workspaceId, globalRank])
  @@index([workspaceId, status, globalRank])
  @@index([buyerGroupRole])
  @@index([decisionPower])
  @@index([influenceLevel])
  @@index([enrichmentScore])
  @@index([lastEnriched])
}

/// Multi-player sales: Co-seller relationships
model person_co_sellers {
  id        String   @id @default(ulid())
  personId  String   @db.VarChar(30)
  userId    String   @db.VarChar(30)
  createdAt DateTime @default(now())
  person    people   @relation(fields: [personId], references: [id], onDelete: Cascade)
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([personId, userId])
  @@index([personId])
  @@index([userId])
  @@index([createdAt])
}

/// Activity and task tracking
model actions {
  id          String         @id @default(ulid())
  workspaceId String         @db.VarChar(30)
  userId      String         @db.VarChar(30)
  companyId   String?        @db.VarChar(30)
  personId    String?        @db.VarChar(30)
  type        String         @db.VarChar(30)
  subject     String
  description String?
  outcome     String?
  scheduledAt DateTime?
  completedAt DateTime?
  status      ActionStatus   @default(PLANNED)
  priority    ActionPriority @default(NORMAL)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime
  deletedAt   DateTime?
  company     companies?     @relation(fields: [companyId], references: [id])
  person      people?        @relation(fields: [personId], references: [id])
  user        users          @relation("AssignedActions", fields: [userId], references: [id], onDelete: Cascade)
  workspace   workspaces     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([companyId])
  @@index([personId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
  @@index([workspaceId, status])
  @@index([workspaceId, userId, status])
  @@index([workspaceId, scheduledAt])
  @@index([workspaceId, createdAt])
}

/// System audit trail for compliance
model audit_logs {
  id          String     @id @default(ulid())
  workspaceId String     @db.VarChar(30)
  userId      String     @db.VarChar(30)
  entityType  String     @db.VarChar(50)
  entityId    String     @db.VarChar(30)
  action      String     @db.VarChar(20)
  oldValues   Json?
  newValues   Json?
  timestamp   DateTime   @default(now())
  success     Boolean    @default(true)
  user        users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([timestamp])
  @@index([workspaceId, entityType, timestamp])
  @@index([workspaceId, action, timestamp])
  @@index([success])
}

/// Grand Central Integration Hub Models
model grand_central_connections {
  id                String     @id @default(ulid())
  workspaceId       String     @db.VarChar(30)
  userId            String     @db.VarChar(30)
  provider          String     @db.VarChar(100)
  providerConfigKey String     @db.VarChar(100)
  nangoConnectionId String     @unique @db.VarChar(100)
  connectionName    String?    @db.VarChar(255)
  metadata          Json       @default("{}")
  status            String     @default("active") @db.VarChar(50)
  lastSyncAt        DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  user              users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace         workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
  @@index([userId])
  @@index([provider])
}

model grand_central_workflows {
  id             String     @id @default(ulid())
  workspaceId    String     @db.VarChar(30)
  userId         String     @db.VarChar(30)
  name           String     @db.VarChar(255)
  description    String?
  nodes          Json       @default("[]")
  connections    Json       @default("[]")
  status         String     @default("draft") @db.VarChar(50)
  lastExecutedAt DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  user           users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace      workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
  @@index([userId])
}

model grand_central_executions {
  id          String    @id @default(ulid())
  workflowId  String    @db.VarChar(30)
  workspaceId String    @db.VarChar(30)
  status      String    @db.VarChar(50)
  logs        Json      @default("[]")
  error       String?
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([workflowId])
  @@index([workspaceId, status])
  @@index([startedAt])
}

/// Oasis - Team Communication (Slack-like)
model OasisChannel {
  id          String               @id @default(cuid())
  workspaceId String               @db.VarChar(30)
  name        String               @db.VarChar(100)
  description String?              @db.VarChar(500)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  workspace   workspaces           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  members     OasisChannelMember[]
  messages    OasisMessage[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model OasisChannelMember {
  id        String       @id @default(cuid())
  channelId String
  userId    String       @db.VarChar(30)
  joinedAt  DateTime     @default(now())
  channel   OasisChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      users        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
}

model OasisDirectMessage {
  id           String               @id @default(cuid())
  workspaceId  String               @db.VarChar(30)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  participants OasisDMParticipant[]
  workspace    workspaces           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages     OasisMessage[]

  @@index([workspaceId])
}

model OasisDMParticipant {
  id       String             @id @default(cuid())
  dmId     String
  userId   String             @db.VarChar(30)
  joinedAt DateTime           @default(now())
  dm       OasisDirectMessage @relation(fields: [dmId], references: [id], onDelete: Cascade)
  user     users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dmId, userId])
  @@index([dmId])
  @@index([userId])
}

model OasisMessage {
  id        String              @id @default(cuid())
  content   String
  channelId String?
  dmId      String?
  senderId  String              @db.VarChar(30)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  channel   OasisChannel?       @relation(fields: [channelId], references: [id], onDelete: Cascade)
  dm        OasisDirectMessage? @relation(fields: [dmId], references: [id], onDelete: Cascade)
  sender    users               @relation(fields: [senderId], references: [id], onDelete: Cascade)
  reactions OasisReaction[]

  @@index([channelId])
  @@index([dmId])
  @@index([senderId])
  @@index([createdAt])
}

model OasisReaction {
  id        String       @id @default(cuid())
  messageId String
  userId    String       @db.VarChar(30)
  emoji     String       @db.VarChar(10)
  createdAt DateTime     @default(now())
  message   OasisMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      users        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

/// Stacks - Project Management (Jira-like)
model StacksProject {
  id          String        @id @default(cuid())
  workspaceId String        @db.VarChar(30)
  name        String        @db.VarChar(200)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  epics       StacksEpic[]
  workspace   workspaces    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  stories     StacksStory[]
  tasks       StacksTask[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model StacksEpic {
  id          String        @id @default(cuid())
  projectId   String
  title       String        @db.VarChar(200)
  description String?
  status      String        @default("todo") @db.VarChar(20)
  priority    String        @default("medium") @db.VarChar(20)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  project     StacksProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories     StacksStory[]

  @@index([projectId])
  @@index([projectId, status])
}

model StacksStory {
  id          String        @id @default(cuid())
  epicId      String?
  projectId   String
  title       String        @db.VarChar(200)
  description String?
  status      String        @default("todo") @db.VarChar(20)
  priority    String        @default("medium") @db.VarChar(20)
  assigneeId  String?       @db.VarChar(30)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  assignee    users?        @relation(fields: [assigneeId], references: [id])
  epic        StacksEpic?   @relation(fields: [epicId], references: [id])
  project     StacksProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       StacksTask[]

  @@index([epicId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([projectId, status])
}

model StacksTask {
  id          String        @id @default(cuid())
  storyId     String?
  projectId   String
  title       String        @db.VarChar(200)
  description String?
  status      String        @default("todo") @db.VarChar(20)
  priority    String        @default("medium") @db.VarChar(20)
  type        String        @default("task") @db.VarChar(20)
  assigneeId  String?       @db.VarChar(30)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  assignee    users?        @relation(fields: [assigneeId], references: [id])
  project     StacksProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  story       StacksStory?  @relation(fields: [storyId], references: [id])

  @@index([storyId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([projectId, status])
  @@index([projectId, type])
}

model BuyerGroupMembers {
  id             String         @id
  buyerGroupId   String
  name           String
  title          String?
  role           BuyerGroupRole
  email          String?
  phone          String?
  linkedin       String?
  confidence     Decimal?       @default(0) @db.Decimal(5, 2)
  influenceScore Decimal?       @default(0) @db.Decimal(5, 2)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  BuyerGroups    BuyerGroups    @relation(fields: [buyerGroupId], references: [id], onDelete: Cascade)

  @@index([buyerGroupId])
  @@index([role])
}

model BuyerGroups {
  id                String              @id
  companyName       String
  website           String?
  industry          String?
  companySize       String?
  workspaceId       String?
  cohesionScore     Decimal?            @default(0) @db.Decimal(5, 2)
  overallConfidence Decimal?            @default(0) @db.Decimal(5, 2)
  totalMembers      Int                 @default(0)
  processingTime    Int                 @default(0)
  metadata          Json?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  BuyerGroupMembers BuyerGroupMembers[]

  @@index([companyName])
  @@index([createdAt])
  @@index([workspaceId])
}

model ChronicleReport {
  id             String              @id
  title          String
  reportType     ChronicleReportType
  content        Json
  weekStart      DateTime
  weekEnd        DateTime
  workspaceId    String
  userId         String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  ChronicleShare ChronicleShare[]

  @@index([userId, createdAt])
  @@index([workspaceId, weekStart])
}

model ChronicleShare {
  id              String          @id
  reportId        String
  shareToken      String          @unique
  shareUrl        String?
  expiresAt       DateTime?
  allowedEmails   String[]
  viewCount       Int             @default(0)
  createdAt       DateTime        @default(now())
  ChronicleReport ChronicleReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([shareToken])
}

enum UserRole {
  SUPER_ADMIN
  WORKSPACE_ADMIN
  MANAGER
  SELLER
  VIEWER
}

enum Permission {
  WORKSPACE_CREATE
  WORKSPACE_UPDATE
  WORKSPACE_DELETE
  WORKSPACE_VIEW
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  USER_VIEW
  COMPANY_CREATE
  COMPANY_UPDATE
  COMPANY_DELETE
  COMPANY_VIEW
  PERSON_CREATE
  PERSON_UPDATE
  PERSON_DELETE
  PERSON_VIEW
  ACTION_CREATE
  ACTION_UPDATE
  ACTION_DELETE
  ACTION_VIEW
  AUDIT_VIEW
  AUDIT_EXPORT
}

enum ActionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ActionPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PROSPECT
  CLIENT
  OPPORTUNITY
}

enum CompanyPriority {
  LOW
  MEDIUM
  HIGH
}

enum PersonStatus {
  LEAD
  PROSPECT
  OPPORTUNITY
  CLIENT
  SUPERFAN
}

enum PersonPriority {
  LOW
  MEDIUM
  HIGH
}

enum BuyerGroupRole {
  decision
  champion
  stakeholder
  blocker
  introducer
}

enum ChronicleReportType {
  MONDAY_PREP
  FRIDAY_RECAP
}

enum MessageType {
  USER
  ASSISTANT
}

/// AI Chat Persistence Models
model ai_conversations {
  id              String        @id @default(ulid())
  workspaceId     String        @db.VarChar(30)
  userId          String        @db.VarChar(30)
  title           String        @db.VarChar(200)
  lastActivity    DateTime      @updatedAt
  isActive        Boolean       @default(true)
  welcomeMessage  String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime?
  
  user            users         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace       workspaces    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages        ai_messages[]
  
  @@index([workspaceId, userId, deletedAt])
  @@index([lastActivity])
  @@index([workspaceId, userId, isActive])
}

model ai_messages {
  id              String           @id @default(ulid())
  conversationId  String
  type            MessageType
  content         String
  metadata        Json?            // sources, todos, routing, costs, etc.
  createdAt       DateTime         @default(now())
  
  conversation    ai_conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId, createdAt])
  @@index([conversationId, type])
}

/// Email messages from integrated providers
model email_messages {
  id            String    @id @default(ulid())
  workspaceId   String    @db.VarChar(30)
  
  // Provider info
  provider      String    @db.VarChar(50)  // 'outlook', 'gmail'
  messageId     String    // External message ID
  threadId      String?   // Conversation thread
  
  // Email content
  subject       String
  body          String    @db.Text
  bodyHtml      String?   @db.Text
  
  // Participants
  from          String    @db.VarChar(300)
  to            String[]  @default([])
  cc            String[]  @default([])
  bcc           String[]  @default([])
  
  // Metadata
  sentAt        DateTime
  receivedAt    DateTime
  isRead        Boolean   @default(false)
  isImportant   Boolean   @default(false)
  
  // Rich data (JSON)
  attachments   Json?     // Array of attachment metadata
  labels        String[]  @default([])
  
  // Relationships
  companyId     String?   @db.VarChar(30)
  personId      String?   @db.VarChar(30)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  workspace     workspaces @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  company       companies? @relation(fields: [companyId], references: [id])
  person        people?    @relation(fields: [personId], references: [id])
  
  @@unique([provider, messageId, workspaceId])
  @@index([workspaceId])
  @@index([companyId])
  @@index([personId])
  @@index([workspaceId, receivedAt])
  @@index([from])
}
